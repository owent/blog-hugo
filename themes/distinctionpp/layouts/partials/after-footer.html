{{- $default_highlightjs_js := "//cdnjs.cloudflare.com/ajax/libs/highlight.js/%VERSION%/highlight.min.js" }}
{{- $default_highlightjs_css := "//cdnjs.cloudflare.com/ajax/libs/highlight.js/%VERSION%/styles/%STYLE%.min.css" }}
{{- $default_highlightjs_lang := "//cdnjs.cloudflare.com/ajax/libs/highlight.js/%VERSION%/languages/%LANG%.min.js" }}
{{- $default_mathjax_js := "https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" }}
{{- $default_katex_js := "https://cdn.jsdelivr.net/npm/katex/dist/katex.min.js" }}
{{- $default_katex_css := "https://cdn.jsdelivr.net/npm/katex/dist/katex.min.css" }}
{{- $default_katex_autorender := "https://cdn.jsdelivr.net/npm/katex/dist/contrib/auto-render.min.js" }}
{{- $default_chartjs_js := "https://cdn.jsdelivr.net/npm/chart.js" }}
{{- $hasMermaid := .Store.Get "themeExtensionHasMermaid" -}}
{{- if not $hasMermaid -}}
  {{- with .Content -}}
    {{- $hasMermaid = gt (len (findRE `language-(\{)?mermaid(\})?` .)) 0 -}}
  {{- end -}}
{{- end -}}
{{- $hasExcalidraw := .Store.Get "themeExtensionHasExcalidraw" -}}
{{- if not $hasExcalidraw -}}
  {{- with .Content -}}
    {{- $hasExcalidraw = gt (len (findRE `language-(\{)?excalidraw(\})?` .)) 0 -}}
  {{- end -}}
{{- end -}}
{{- $imports := dict -}}
{{- with $.Site.Params.modules -}}
  {{- with .importmap -}}
    {{- $imports = merge $imports . -}}
  {{- end -}}
  {{- if and $.Site.Params.bootstrap $.Site.Params.bootstrap.js -}}
    {{- $imports = merge $imports (dict "bootstrap" $.Site.Params.bootstrap.js) -}}
  {{- else -}}
    {{- $imports = merge $imports (dict "bootstrap" "https://esm.run/bootstrap") -}}
  {{- end -}}
  {{- if and $.Site.Params.bootstrap $.Site.Params.bootstrap.popper $.Site.Params.bootstrap.popper.js -}}
    {{- $imports = merge $imports (dict "@popperjs/core" $.Site.Params.bootstrap.popper.js) -}}
  {{- else -}}
    {{- $imports = merge $imports (dict "@popperjs/core" "https://esm.run/popper.js") -}}
  {{- end -}}
{{- end -}}
{{- if $hasMermaid -}}
  {{- $mermaidJs := "https://esm.sh/mermaid" -}}
  {{- with $.Site.Params.mermaid -}}
    {{- with .js -}}
      {{- $mermaidJs = . -}}
    {{- end -}}
  {{- end -}}
  {{- $imports = merge $imports (dict "mermaid" $mermaidJs) -}}
{{- end -}}
{{- if $hasExcalidraw -}}
  {{- $excalidrawJs := "https://esm.sh/@excalidraw/excalidraw" -}}
  {{- with $.Site.Params.excalidraw -}}
    {{- with .js -}}
      {{- $excalidrawJs = . -}}
    {{- end -}}
  {{- end -}}
  {{- $imports = merge $imports (dict "@excalidraw/excalidraw" $excalidrawJs "excalidraw" $excalidrawJs) -}}
{{- end -}}
{{- if gt (len $imports) 0 -}}
<script type="importmap">
{{ dict "imports" $imports | jsonify | safeHTML }}
</script>
{{- end }}
<script type="module">
{{- "// import * as Popper from \"@popperjs/core\";" | safeJS }}
{{- "// import * as bootstrap from \"bootstrap\";" | safeJS }}
{{- with $.Site.Params.modules }}
    {{- with .module }}
        {{- range . }}
{{ . | safeJS }}
        {{ end }}
    {{- end }}
{{- end }}
</script>
{{- with $.Site.Params.highlightjs }}
<!-- highlight.js begin -->
<script type="text/javascript" src='{{ replace (default $default_highlightjs_js .url.js) "%VERSION%" .version | safeURL  }}'></script>
    {{- range $lang := .langs }}
<script type="text/javascript" src='{{ replace (replace (default $default_highlightjs_lang $.Site.Params.highlightjs.url.lang) "%VERSION%" $.Site.Params.highlightjs.version) "%LANG%" $lang | safeURL  }}'></script>
    {{- end }}
<script type="text/javascript">
document.addEventListener('DOMContentLoaded', (event) => {
    const hljs_style = document.createElement('link');
    hljs_style.rel = 'stylesheet';
    hljs_style.href = '{{ replace (replace (default $default_highlightjs_css .url.style) "%VERSION%" .version) "%STYLE%" .style | safeURL | safeJS  }}';
    document.querySelector('head').appendChild(hljs_style);
    if (window.JSON) {
        hljs.configure(JSON.parse({{ .options | jsonify }}));
    } else {
        hljs.configure(evel({{ .options | jsonify }}));
    }
    const allLanguages = {};
    for (const lang of hljs.listLanguages() ) {
        allLanguages[lang.toLowerCase()] = true;
    }

    for(const block of document.querySelectorAll('{{ .selector | default "pre>code" }}')) {
        try {
            if (block.className.match(/\bmermaid\b/i)) {
                block.classList.add("mermaid");
                continue;
            }
            if (block.className.match(/\bexcalidraw\b/i)) {
                block.classList.add("excalidraw-root");
                continue;
            }
            if (block.className.match(/\bnohighlight\b/i)) {
                continue;
            }
            const detectLang = block.className.match(/language-([^\s]+)/i);
            if (detectLang && detectLang.length >= 2 && hljs.getLanguage(detectLang[1])) {
                hljs.highlightElement(block);
            } else {
                const result = hljs.highlightAuto(block.innerText, hljs.listLanguages());
                if (result && result.value) {
                    block.innerHTML = result.value;
                    block.classList.add("hljs");
                }
            }
        } catch (e) {
            if (window.console) {
                console.log(e.toString() + "\r\nMaybe can not detect the language");
            }
        }
    }
});
</script>
<!-- highlight.js end -->
{{- end }}{{ partial "google-analytics.html" . }}
{{- with $.Site.Params.mathjax }}<!-- mathjax begin -->
<script type="text/javascript">
window.MathJax = {
    tex: {
        inlineMath: [['\\(','\\)']],
        displayMath: [['$$','$$'], ['\[','\]']],
        processEscapes: true,
        processEnvironments: true
    },
    options: {
        skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
};
</script>
<script src="{{ .js | default $default_mathjax_js | safeURL }}" id="MathJax-script" async></script>
<!-- mathjax end -->
{{- end }}
{{- with $.Site.Params.katex }}<!-- katex begin -->
<script type="text/javascript" src='{{ .js | default $default_katex_js | safeURL }}'></script>
<script type="text/javascript" src='{{ .autorender | default $default_katex_autorender | safeURL }}'></script>
<script type="text/javascript">
document.addEventListener('DOMContentLoaded', (event) => {
    const katex_style = document.createElement('link');
    katex_style.rel = 'stylesheet';
    katex_style.href = '{{ .css | default $default_katex_css | safeJS  }}';
    document.querySelector('head').appendChild(katex_style);
    renderMathInElement(document.body, {
        delimiters: [
            {left: "$$", right: "$$", display: true},
            {left: "\\[", right: "\\]", display: true},
            {left: "\\(", right: "\\)", display: false},
            {left: "$", right: "$", display: false},
        ],
        throwOnError : false,
        ignoredTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    });
});
</script>
<!-- katex end -->
{{- end }}
{{- if .Store.Get "themeExtensionHasChartJs" }}
  {{- $chartJsUrl := $default_chartjs_js -}}
  {{- with $.Site.Params.chartjs -}}
    {{- with .js -}}
      {{- $chartJsUrl = . -}}
    {{- end -}}
  {{- end -}}<!-- chart.js begin -->
<script type="text/javascript" src='{{ $chartJsUrl | safeURL }}'></script>
<!-- chart.js end -->
{{- end }}
{{- if $hasMermaid }}
  {{- $mermaidTheme := "default" -}}
  {{- with $.Site.Params.mermaid -}}
    {{- with .theme -}}
      {{- $mermaidTheme = . -}}
    {{- end -}}
  {{- end -}}<!-- mermaid begin -->
<script type="module">
import mermaid from "mermaid";
const config = {
    theme: '{{ $mermaidTheme }}',
    logLevel: 'fatal',
    securityLevel: 'loose', // 'sandbox', 'strict', 'loose', 'antiscript'
    startOnLoad: true,
    arrowMarkerAbsolute: false,
    /*
    er: {
        diagramPadding: 20,
        layoutDirection: 'TB',
        minEntityWidth: 100,
        minEntityHeight: 75,
        entityPadding: 15,
        stroke: 'gray',
        fill: 'honeydew',
        fontSize: 12,
        useMaxWidth: true,
    },
    flowchart: {
        diagramPadding: 8,
        htmlLabels: true,
        curve: 'basis',
    },
    sequence: {
        diagramMarginX: 50,
        diagramMarginY: 10,
        actorMargin: 50,
        width: 150,
        height: 65,
        boxMargin: 10,
        boxTextMargin: 5,
        noteMargin: 10,
        messageMargin: 35,
        messageAlign: 'center',
        mirrorActors: true,
        bottomMarginAdj: 1,
        useMaxWidth: true,
        rightAngles: false,
        showSequenceNumbers: false,
    },
    gantt: {
        titleTopMargin: 25,
        barHeight: 20,
        barGap: 4,
        topPadding: 50,
        leftPadding: 75,
        gridLineStartPadding: 35,
        fontSize: 11,
        fontFamily: '"Open Sans", sans-serif',
        numberSectionStyles: 4,
        axisFormat: '%Y-%m-%d',
        topAxis: false,
    },*/
};
mermaid.initialize(config);
</script>
<!-- mermaid end -->
{{- end }}
{{- if $hasExcalidraw }}<!-- excalidraw begin -->
  {{- $excalidrawCss := "https://cdn.jsdelivr.net/npm/@excalidraw/excalidraw/dist/excalidraw.min.css" -}}
  {{- with $.Site.Params.excalidraw -}}
    {{- with .css -}}
      {{- $excalidrawCss = . -}}
    {{- end -}}
  {{- end -}}
<script type="module">
(async () => {
    const ensureCss = () => {
        const id = "excalidraw-css";
        if (document.getElementById(id)) {
            return;
        }
        const link = document.createElement("link");
        link.id = id;
        link.rel = "stylesheet";
        link.href = "{{ $excalidrawCss | safeJS }}";
        document.head.appendChild(link);
    };

    const isExcalidrawCodeBlock = (codeEl) => {
        if (!codeEl || !codeEl.className) {
            return false;
        }
        return /(^|\s)language-(\{)?excalidraw(\})?(\s|$)/i.test(codeEl.className) || /\bexcalidraw\b/i.test(codeEl.className);
    };

    const roots = [];
    for (const el of document.querySelectorAll('.excalidraw-root')) {
        const dataId = el.getAttribute && el.getAttribute("data-excalidraw-data-id");
        if (!dataId) {
            continue;
        }
        roots.push({
            rootEl: el,
            codeEl: null,
            getInitialData: () => {
                const jsonEl = document.getElementById(dataId);
                return jsonEl ? (jsonEl.textContent || "{}") : null;
            },
        });
    }
    for (const codeEl of document.querySelectorAll('pre>code')) {
        if (!isExcalidrawCodeBlock(codeEl)) {
            continue;
        }
        const preEl = codeEl.parentElement;
        if (!preEl) {
            continue;
        }
        const raw = codeEl.textContent || "";
        if (!raw.trim()) {
            continue;
        }
        const rootEl = document.createElement("div");
        rootEl.className = "excalidraw-root";
        rootEl.style.width = "100%";
        rootEl.style.height = "auto";
        const container = document.createElement("div");
        container.className = "excalidraw-container";
        container.style.height = codeEl.style.height || "auto";
        container.style.width = codeEl.style.width || "100%";
        container.style.margin = codeEl.style.margin || "1rem 0";
        container.appendChild(rootEl);
        preEl.parentNode.insertBefore(container, preEl);
        codeEl.textContent = "Loading excalidraw libraries...";
        roots.push({ rootEl, codeEl, getInitialData: () => raw, sourceEl: preEl, containerEl: container });
    }

    if (roots.length <= 0) {
        return;
    }

    const restoreFn = (reason, item) => {
        if (item) {
            if (item.codeEl) {
                item.codeEl.textContent = item.getInitialData();
            } else {
                const reason = document.createElement("div");
                reason.textContent = reason;
                const preEl = document.createElement("pre");
                const codeEl = document.createElement("code");
                codeEl.textContent = item.getInitialData();
                preEl.appendChild(codeEl);
                item.rootEl.replaceChildren([reason, preEl]);
            }
            return;
        }
        for (const item of roots) {
            if (item.codeEl) {
                item.codeEl.textContent = item.getInitialData();
            } else {
                const reason = document.createElement("div");
                reason.textContent = reason;
                const preEl = document.createElement("pre");
                const codeEl = document.createElement("code");
                codeEl.textContent = item.getInitialData();
                preEl.appendChild(codeEl);
                item.rootEl.replaceChildren([reason, preEl]);
            }
        }
    };

    let exportToSvg;
    try {
        ensureCss();
        let ExcalidrawPkg = await import("@excalidraw/excalidraw");
        exportToSvg =
            ExcalidrawPkg.exportToSvg ||
            (ExcalidrawPkg.default && ExcalidrawPkg.default.exportToSvg) ||
            null;
        if (typeof exportToSvg !== "function") {
            ExcalidrawPkg = await import("https://esm.sh/@excalidraw/excalidraw");
            exportToSvg =
                ExcalidrawPkg.exportToSvg ||
                (ExcalidrawPkg.default && ExcalidrawPkg.default.exportToSvg) ||
                null;
        }
    } catch (e) {
        if (window.console) {
            console.error("Failed to load excalidraw dependencies", e);
        }
        restoreFn("Failed to load excalidraw libraries");
        return;
    }

    if (typeof exportToSvg !== "function") {
        if (window.console) {
            console.error("Invalid excalidraw module exports: missing exportToSvg");
        }
        restoreFn("Invalid excalidraw module exports: missing exportToSvg");
        return;
    }

    for (const item of roots) {
        const rootEl = item.rootEl;
        const raw = item.getInitialData();
        if (!raw) {
            continue;
        }
        let sceneData = null;
        try {
            const parsed = JSON.parse(raw);
            if (parsed && typeof parsed === "object" && parsed.type === "excalidraw" && Array.isArray(parsed.elements)) {
                sceneData = {
                    elements: parsed.elements,
                    appState: parsed.appState || {},
                    files: parsed.files || {},
                };
            } else {
                sceneData = parsed;
            }
        } catch (e) {
            if (window.console) {
                console.error("Invalid excalidraw json", e);
            }
            restoreFn("Invalid excalidraw json", item);
            continue;
        }

        try {
            const elements = sceneData && sceneData.elements ? sceneData.elements : (Array.isArray(sceneData) ? sceneData : []);
            const appState = sceneData && sceneData.appState ? sceneData.appState : {};
            const files = sceneData && sceneData.files ? sceneData.files : {};

            const svg = await exportToSvg({
                elements,
                appState,
                files,
                exportPadding: 10,
            });
            if (!svg) {
                restoreFn("Invalid excalidraw json", item);
                continue;
            }
            svg.style.width = "100%";
            svg.style.height = "auto";
            svg.style.display = "block";
            rootEl.replaceChildren(svg);
            if (item.sourceEl) {
                item.sourceEl.style.display = "none";
            }
            if (item.containerEl) {
                item.containerEl.style.height = "auto";
            }
        } catch (e) {
            if (window.console) {
                console.error("Failed to render excalidraw", e);
            }
            restoreFn("Failed to render excalidraw", item);
        }
    }
})();
</script>
<!-- excalidraw end -->
{{- end }}
{{ with $.Site.Params.styleimport }}<!-- style import begin -->
<script type="text/javascript">
document.addEventListener('DOMContentLoaded', (event) => {
    setTimeout(function() {
        var import_items = '';
        {{- range $url := .urls }}
        import_items += "@import url('{{ $url | safeJS }}');\r\n";
        {{ end }}

        if (import_items) {
            const import_style = document.createElement('style');
            import_style.innerHTML = import_items;
            document.querySelector('head').appendChild(import_style);
        }
    }, {{ default 256 .delay }});
});
</script>
<!-- style import end -->
{{- end }}
{{- with $.Site.Params.Content }}
  {{- with .after_footer }}
    {{- range . -}}
    <script
      {{- with .attributes }}
        {{- range $k, $v := . -}}
            {{- " " | safeHTMLAttr }}{{ $k | safeHTMLAttr }}="{{ $v | safeHTMLAttr }}"
        {{- end -}}
      {{- end -}}
    >
      {{- with .content }}
        {{- . | safeJS }}
      {{- end -}}
    </script>
    {{- end}}
  {{- end}}
{{- end}}
