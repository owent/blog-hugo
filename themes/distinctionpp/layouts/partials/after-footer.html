{{- $default_highlightjs_js := "//cdnjs.cloudflare.com/ajax/libs/highlight.js/%VERSION%/highlight.min.js" }}
{{- $default_highlightjs_css := "//cdnjs.cloudflare.com/ajax/libs/highlight.js/%VERSION%/styles/%STYLE%.min.css" }}
{{- $default_highlightjs_lang := "//cdnjs.cloudflare.com/ajax/libs/highlight.js/%VERSION%/languages/%LANG%.min.js" }}
{{- $default_mathjax_js := "https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" }}
{{- $default_katex_js := "https://cdn.jsdelivr.net/npm/katex/dist/katex.min.js" }}
{{- $default_katex_css := "https://cdn.jsdelivr.net/npm/katex/dist/katex.min.css" }}
{{- $default_katex_autorender := "https://cdn.jsdelivr.net/npm/katex/dist/contrib/auto-render.min.js" }}
{{- $default_chartjs_js := "https://cdn.jsdelivr.net/npm/chart.js" }}
{{- $hasMermaid := .Store.Get "themeExtensionHasMermaid" -}}
{{- if not $hasMermaid -}}
  {{- with .Content -}}
    {{- $hasMermaid = gt (len (findRE `language-(\{)?mermaid(\})?` .)) 0 -}}
  {{- end -}}
{{- end -}}
{{- $hasExcalidraw := .Store.Get "themeExtensionHasExcalidraw" -}}
{{- if not $hasExcalidraw -}}
  {{- with .Content -}}
    {{- $hasExcalidraw = gt (len (findRE `language-(\{)?excalidraw(\})?` .)) 0 -}}
  {{- end -}}
{{- end -}}
{{- $hasDrawio := .Store.Get "themeExtensionHasDrawio" -}}
{{- if not $hasDrawio -}}
  {{- with .Content -}}
    {{- $hasDrawio = gt (len (findRE `language-(\{)?drawio(\})?` .)) 0 -}}
  {{- end -}}
{{- end -}}
{{- $hasChartJs := .Store.Get "themeExtensionHasChartJs" -}}
{{- if not $hasChartJs -}}
  {{- with .Content -}}
    {{- $hasChartJs = gt (len (findRE `language-(\{)?(chart|chartjs)(\})?` .)) 0 -}}
  {{- end -}}
{{- end -}}
{{- $imports := dict -}}
{{- with $.Site.Params.modules -}}
  {{- with .importmap -}}
    {{- $imports = merge $imports . -}}
  {{- end -}}
  {{- if and $.Site.Params.bootstrap $.Site.Params.bootstrap.js -}}
    {{- $imports = merge $imports (dict "bootstrap" $.Site.Params.bootstrap.js) -}}
  {{- else -}}
    {{- $imports = merge $imports (dict "bootstrap" "https://esm.run/bootstrap") -}}
  {{- end -}}
  {{- if and $.Site.Params.bootstrap $.Site.Params.bootstrap.popper $.Site.Params.bootstrap.popper.js -}}
    {{- $imports = merge $imports (dict "@popperjs/core" $.Site.Params.bootstrap.popper.js) -}}
  {{- else -}}
    {{- $imports = merge $imports (dict "@popperjs/core" "https://esm.run/popper.js") -}}
  {{- end -}}
{{- end -}}
{{- if $hasMermaid -}}
  {{- $mermaidJs := "https://esm.sh/mermaid" -}}
  {{- with $.Site.Params.mermaid -}}
    {{- with .js -}}
      {{- $mermaidJs = . -}}
    {{- end -}}
  {{- end -}}
  {{- $imports = merge $imports (dict "mermaid" $mermaidJs) -}}
{{- end -}}
{{- if $hasExcalidraw -}}
  {{- $excalidrawJs := "https://esm.sh/@excalidraw/excalidraw" -}}
  {{- with $.Site.Params.excalidraw -}}
    {{- with .js -}}
      {{- $excalidrawJs = . -}}
    {{- end -}}
  {{- end -}}
  {{- $imports = merge $imports (dict "@excalidraw/excalidraw" $excalidrawJs "excalidraw" $excalidrawJs) -}}
{{- end -}}
{{- if gt (len $imports) 0 -}}
<script type="importmap">
{{ dict "imports" $imports | jsonify | safeHTML }}
</script>
{{- end }}
<script type="module">
{{- "// import * as Popper from \"@popperjs/core\";" | safeJS }}
{{- "// import * as bootstrap from \"bootstrap\";" | safeJS }}
{{- with $.Site.Params.modules }}
    {{- with .module }}
        {{- range . }}
{{ . | safeJS }}
        {{ end }}
    {{- end }}
{{- end }}
</script>
{{- with $.Site.Params.highlightjs }}
<!-- highlight.js begin -->
<script type="text/javascript" src='{{ replace (default $default_highlightjs_js .url.js) "%VERSION%" .version | safeURL  }}'></script>
    {{- range $lang := .langs }}
<script type="text/javascript" src='{{ replace (replace (default $default_highlightjs_lang $.Site.Params.highlightjs.url.lang) "%VERSION%" $.Site.Params.highlightjs.version) "%LANG%" $lang | safeURL  }}'></script>
    {{- end }}
<script type="text/javascript">
document.addEventListener('DOMContentLoaded', (event) => {
    const hljs_style = document.createElement('link');
    hljs_style.rel = 'stylesheet';
    hljs_style.href = '{{ replace (replace (default $default_highlightjs_css .url.style) "%VERSION%" .version) "%STYLE%" .style | safeURL | safeJS  }}';
    document.querySelector('head').appendChild(hljs_style);
    if (window.JSON) {
        hljs.configure(JSON.parse({{ .options | jsonify }}));
    } else {
        hljs.configure(evel({{ .options | jsonify }}));
    }
    const allLanguages = {};
    for (const lang of hljs.listLanguages() ) {
        allLanguages[lang.toLowerCase()] = true;
    }

    for(const block of document.querySelectorAll('{{ .selector | default "pre>code" }}')) {
        try {
            if (block.className.match(/\bmermaid\b/i)) {
                block.classList.add("mermaid");
                continue;
            }
            if (block.className.match(/\bexcalidraw\b/i)) {
                block.classList.add("excalidraw-root");
                continue;
            }
            if (block.className.match(/\bdrawio\b/i)) {
                block.classList.add("drawio-root");
                block.classList.add("mxgraph");
                continue;
            }
            if (block.className.match(/\bchart(js)?\b/i)) {
                block.classList.add("chartjs-container");
                continue;
            }
            if (block.className.match(/\bnohighlight\b/i)) {
                continue;
            }
            const detectLang = block.className.match(/language-([^\s]+)/i);
            if (detectLang && detectLang.length >= 2 && hljs.getLanguage(detectLang[1])) {
                hljs.highlightElement(block);
            } else {
                const result = hljs.highlightAuto(block.innerText, hljs.listLanguages());
                if (result && result.value) {
                    block.innerHTML = result.value;
                    block.classList.add("hljs");
                }
            }
        } catch (e) {
            if (window.console) {
                console.log(e.toString() + "\r\nMaybe can not detect the language");
            }
        }
    }
});
</script>
<!-- highlight.js end -->
{{- end }}{{ partial "google-analytics.html" . }}
{{- with $.Site.Params.mathjax }}<!-- mathjax begin -->
<script type="text/javascript">
window.MathJax = {
    tex: {
        inlineMath: [['\\(','\\)']],
        displayMath: [['$$','$$'], ['\[','\]']],
        processEscapes: true,
        processEnvironments: true
    },
    options: {
        skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
};
</script>
<script src="{{ .js | default $default_mathjax_js | safeURL }}" id="MathJax-script" async></script>
<!-- mathjax end -->
{{- end }}
{{- with $.Site.Params.katex }}<!-- katex begin -->
<script type="text/javascript" src='{{ .js | default $default_katex_js | safeURL }}'></script>
<script type="text/javascript" src='{{ .autorender | default $default_katex_autorender | safeURL }}'></script>
<script type="text/javascript">
document.addEventListener('DOMContentLoaded', (event) => {
    const katex_style = document.createElement('link');
    katex_style.rel = 'stylesheet';
    katex_style.href = '{{ .css | default $default_katex_css | safeJS  }}';
    document.querySelector('head').appendChild(katex_style);
    renderMathInElement(document.body, {
        delimiters: [
            {left: "$$", right: "$$", display: true},
            {left: "\\[", right: "\\]", display: true},
            {left: "\\(", right: "\\)", display: false},
            {left: "$", right: "$", display: false},
        ],
        throwOnError : false,
        ignoredTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    });
});
</script>
<!-- katex end -->
{{- end }}
{{- if $hasChartJs }}
  {{- $chartJsUrl := $default_chartjs_js -}}
  {{- with $.Site.Params.chartjs -}}
    {{- with .js -}}
      {{- $chartJsUrl = . -}}
    {{- end -}}
  {{- end -}}<!-- chart.js begin -->
<script type="text/javascript" src='{{ $chartJsUrl | safeURL }}'></script>
<script type="text/javascript">
document.addEventListener('DOMContentLoaded', async (event) => {
    // Helper function to check if element is a chart codeblock
    const isChartCodeBlock = (el) => {
        if (!el || !el.className) return false;
        return /(^|\s)language-(\{)?(chart|chartjs)(\})?(\s|$)/i.test(el.className) || 
               /\b(chart|chartjs)-container\b/i.test(el.className);
    };

    // Process code blocks with chart/chartjs language
    for (const codeEl of document.querySelectorAll('pre>code')) {
        if (!isChartCodeBlock(codeEl)) continue;
        const preEl = codeEl.parentElement;
        if (!preEl) continue;
        
        const jsonContent = codeEl.textContent || '{}';
        try {
            const config = JSON.parse(jsonContent.trim());
            
            // Create container and canvas
            const container = document.createElement('div');
            container.className = 'chartjs-container';
            container.style.cssText = 'width: 100%; margin: 1rem 0;';
            
            const canvas = document.createElement('canvas');
            canvas.id = 'chartjs-codeblock-' + Math.random().toString(36).substr(2, 9);
            container.appendChild(canvas);
            
            // Replace pre with container
            preEl.parentNode.insertBefore(container, preEl);
            preEl.style.display = 'none';
            
            // Initialize chart
            new Chart(canvas, config);
        } catch (e) {
            if (window.console) {
                console.error('Failed to parse chart JSON from codeblock:', e);
            }
        }
    }

    // Initialize charts with inline config (data-chartjs-config-id)
    for (const canvas of document.querySelectorAll('canvas[data-chartjs-config-id]')) {
        const configId = canvas.getAttribute('data-chartjs-config-id');
        if (!configId) continue;
        const configEl = document.getElementById(configId);
        if (!configEl) continue;
        try {
            const config = JSON.parse(configEl.textContent || '{}');
            new Chart(canvas, config);
        } catch (e) {
            if (window.console) {
                console.error('Failed to parse chart config:', e);
            }
        }
    }
    
    // Fetch and initialize charts with external src (data-chartjs-src)
    for (const canvas of document.querySelectorAll('canvas.chartjs-pending[data-chartjs-src]')) {
        const src = canvas.getAttribute('data-chartjs-src');
        if (!src) continue;
        try {
            const response = await fetch(src);
            if (!response.ok) {
                throw new Error(`Failed to fetch ${src}: ${response.status}`);
            }
            const config = await response.json();
            canvas.classList.remove('chartjs-pending');
            new Chart(canvas, config);
        } catch (e) {
            if (window.console) {
                console.error('Failed to load chart:', src, e);
            }
            canvas.classList.remove('chartjs-pending');
            const ctx = canvas.getContext('2d');
            if (ctx) {
                ctx.fillStyle = 'red';
                ctx.font = '14px sans-serif';
                ctx.fillText(`Failed to load: ${src}`, 10, 30);
            }
        }
    }
});
</script>
<!-- chart.js end -->
{{- end }}
{{- if $hasMermaid }}
  {{- $mermaidTheme := "default" -}}
  {{- with $.Site.Params.mermaid -}}
    {{- with .theme -}}
      {{- $mermaidTheme = . -}}
    {{- end -}}
  {{- end -}}<!-- mermaid begin -->
<script type="module">
import mermaid from "mermaid";
const config = {
    theme: '{{ $mermaidTheme }}',
    logLevel: 'fatal',
    securityLevel: 'loose', // 'sandbox', 'strict', 'loose', 'antiscript'
    startOnLoad: false, // We'll manually run after fetching pending diagrams
    arrowMarkerAbsolute: false,
    /*
    er: {
        diagramPadding: 20,
        layoutDirection: 'TB',
        minEntityWidth: 100,
        minEntityHeight: 75,
        entityPadding: 15,
        stroke: 'gray',
        fill: 'honeydew',
        fontSize: 12,
        useMaxWidth: true,
    },
    flowchart: {
        diagramPadding: 8,
        htmlLabels: true,
        curve: 'basis',
    },
    sequence: {
        diagramMarginX: 50,
        diagramMarginY: 10,
        actorMargin: 50,
        width: 150,
        height: 65,
        boxMargin: 10,
        boxTextMargin: 5,
        noteMargin: 10,
        messageMargin: 35,
        messageAlign: 'center',
        mirrorActors: true,
        bottomMarginAdj: 1,
        useMaxWidth: true,
        rightAngles: false,
        showSequenceNumbers: false,
    },
    gantt: {
        titleTopMargin: 25,
        barHeight: 20,
        barGap: 4,
        topPadding: 50,
        leftPadding: 75,
        gridLineStartPadding: 35,
        fontSize: 11,
        fontFamily: '"Open Sans", sans-serif',
        numberSectionStyles: 4,
        axisFormat: '%Y-%m-%d',
        topAxis: false,
    },*/
};
mermaid.initialize(config);

// Fetch pending mermaid diagrams (from .mermaid files)
(async () => {
    const pendingElements = document.querySelectorAll('.mermaid-pending[data-mermaid-src]');
    for (const el of pendingElements) {
        const src = el.getAttribute('data-mermaid-src');
        if (!src) continue;
        try {
            const response = await fetch(src);
            if (!response.ok) {
                throw new Error(`Failed to fetch ${src}: ${response.status}`);
            }
            const content = await response.text();
            el.textContent = content;
            el.classList.remove('mermaid-pending');
        } catch (e) {
            if (window.console) {
                console.error("Failed to fetch mermaid file:", src, e);
            }
            el.textContent = `Failed to load: ${src}`;
            el.classList.remove('mermaid');
            el.classList.remove('mermaid-pending');
        }
    }
    // Now run mermaid on all diagrams
    await mermaid.run();
})();
</script>
<!-- mermaid end -->
{{- end }}
{{- if $hasExcalidraw }}<!-- excalidraw begin -->
  {{- $excalidrawCss := "https://cdn.jsdelivr.net/npm/@excalidraw/excalidraw/dist/excalidraw.min.css" -}}
  {{- with $.Site.Params.excalidraw -}}
    {{- with .css -}}
      {{- $excalidrawCss = . -}}
    {{- end -}}
  {{- end -}}
<script type="module">
(async () => {
    const ensureCss = () => {
        const id = "excalidraw-css";
        if (document.getElementById(id)) {
            return;
        }
        const link = document.createElement("link");
        link.id = id;
        link.rel = "stylesheet";
        link.href = "{{ $excalidrawCss | safeJS }}";
        document.head.appendChild(link);
    };

    const isExcalidrawCodeBlock = (codeEl) => {
        if (!codeEl || !codeEl.className) {
            return false;
        }
        return /(^|\s)language-(\{)?excalidraw(\})?(\s|$)/i.test(codeEl.className) || /\bexcalidraw\b/i.test(codeEl.className);
    };

    const roots = [];
    for (const el of document.querySelectorAll('.excalidraw-root')) {
        const dataId = el.getAttribute && el.getAttribute("data-excalidraw-data-id");
        const dataSrc = el.getAttribute && el.getAttribute("data-excalidraw-src");
        if (!dataId && !dataSrc) {
            continue;
        }
        if (dataId) {
            roots.push({
                rootEl: el,
                codeEl: null,
                getInitialData: () => {
                    const jsonEl = document.getElementById(dataId);
                    return jsonEl ? (jsonEl.textContent || "{}") : null;
                },
            });
        } else if (dataSrc) {
            // For external/static file sources, fetch at runtime
            roots.push({
                rootEl: el,
                codeEl: null,
                dataSrc: dataSrc,
                getInitialData: null, // Will be set after fetch
                needsFetch: true,
            });
        }
    }
    for (const codeEl of document.querySelectorAll('pre>code')) {
        if (!isExcalidrawCodeBlock(codeEl)) {
            continue;
        }
        const preEl = codeEl.parentElement;
        if (!preEl) {
            continue;
        }
        const raw = codeEl.textContent || "";
        if (!raw.trim()) {
            continue;
        }
        const rootEl = document.createElement("div");
        rootEl.className = "excalidraw-root";
        rootEl.style.width = "100%";
        rootEl.style.height = "auto";
        const container = document.createElement("div");
        container.className = "excalidraw-container";
        container.style.height = codeEl.style.height || "auto";
        container.style.width = codeEl.style.width || "100%";
        container.style.margin = codeEl.style.margin || "1rem 0";
        container.appendChild(rootEl);
        preEl.parentNode.insertBefore(container, preEl);
        codeEl.textContent = "Loading excalidraw libraries...";
        roots.push({ rootEl, codeEl, getInitialData: () => raw, sourceEl: preEl, containerEl: container });
    }

    if (roots.length <= 0) {
        return;
    }

    // Fetch external excalidraw files
    for (const item of roots) {
        if (item.needsFetch && item.dataSrc) {
            try {
                const response = await fetch(item.dataSrc);
                if (!response.ok) {
                    throw new Error(`Failed to fetch ${item.dataSrc}: ${response.status}`);
                }
                const content = await response.text();
                item.getInitialData = () => content;
                item.needsFetch = false;
            } catch (e) {
                if (window.console) {
                    console.error("Failed to fetch excalidraw file:", item.dataSrc, e);
                }
                item.rootEl.textContent = `Failed to load: ${item.dataSrc}`;
                item.failed = true;
            }
        }
    }

    // Filter out failed items
    const validRoots = roots.filter(item => !item.failed);
    if (validRoots.length <= 0) {
        return;
    }

    const restoreFn = (reason, item) => {
        if (item) {
            if (item.codeEl) {
                item.codeEl.textContent = item.getInitialData ? item.getInitialData() : "";
            } else if (item.getInitialData) {
                const reasonEl = document.createElement("div");
                reasonEl.textContent = reason;
                const preEl = document.createElement("pre");
                const codeEl = document.createElement("code");
                codeEl.textContent = item.getInitialData();
                preEl.appendChild(codeEl);
                item.rootEl.replaceChildren(reasonEl, preEl);
            } else {
                item.rootEl.textContent = reason;
            }
            return;
        }
        for (const item of validRoots) {
            if (item.codeEl) {
                item.codeEl.textContent = item.getInitialData ? item.getInitialData() : "";
            } else if (item.getInitialData) {
                const reasonEl = document.createElement("div");
                reasonEl.textContent = reason;
                const preEl = document.createElement("pre");
                const codeEl = document.createElement("code");
                codeEl.textContent = item.getInitialData();
                preEl.appendChild(codeEl);
                item.rootEl.replaceChildren(reasonEl, preEl);
            } else {
                item.rootEl.textContent = reason;
            }
        }
    };

    let exportToSvg;
    try {
        ensureCss();
        let ExcalidrawPkg = await import("@excalidraw/excalidraw");
        exportToSvg =
            ExcalidrawPkg.exportToSvg ||
            (ExcalidrawPkg.default && ExcalidrawPkg.default.exportToSvg) ||
            null;
        if (typeof exportToSvg !== "function") {
            ExcalidrawPkg = await import("https://esm.sh/@excalidraw/excalidraw");
            exportToSvg =
                ExcalidrawPkg.exportToSvg ||
                (ExcalidrawPkg.default && ExcalidrawPkg.default.exportToSvg) ||
                null;
        }
    } catch (e) {
        if (window.console) {
            console.error("Failed to load excalidraw dependencies", e);
        }
        restoreFn("Failed to load excalidraw libraries");
        return;
    }

    if (typeof exportToSvg !== "function") {
        if (window.console) {
            console.error("Invalid excalidraw module exports: missing exportToSvg");
        }
        restoreFn("Invalid excalidraw module exports: missing exportToSvg");
        return;
    }

    for (const item of validRoots) {
        const rootEl = item.rootEl;
        const raw = item.getInitialData ? item.getInitialData() : null;
        if (!raw) {
            continue;
        }
        let sceneData = null;
        try {
            const parsed = JSON.parse(raw);
            if (parsed && typeof parsed === "object" && parsed.type === "excalidraw" && Array.isArray(parsed.elements)) {
                sceneData = {
                    elements: parsed.elements,
                    appState: parsed.appState || {},
                    files: parsed.files || {},
                };
            } else {
                sceneData = parsed;
            }
        } catch (e) {
            if (window.console) {
                console.error("Invalid excalidraw json", e);
            }
            restoreFn("Invalid excalidraw json", item);
            continue;
        }

        try {
            const elements = sceneData && sceneData.elements ? sceneData.elements : (Array.isArray(sceneData) ? sceneData : []);
            const appState = sceneData && sceneData.appState ? sceneData.appState : {};
            const files = sceneData && sceneData.files ? sceneData.files : {};

            const svg = await exportToSvg({
                elements,
                appState,
                files,
                exportPadding: 10,
            });
            if (!svg) {
                restoreFn("Invalid excalidraw json", item);
                continue;
            }
            svg.style.width = "100%";
            svg.style.height = "auto";
            svg.style.display = "block";
            rootEl.replaceChildren(svg);
            if (item.sourceEl) {
                item.sourceEl.style.display = "none";
            }
            if (item.containerEl) {
                item.containerEl.style.height = "auto";
            }
        } catch (e) {
            if (window.console) {
                console.error("Failed to render excalidraw", e);
            }
            restoreFn("Failed to render excalidraw", item);
        }
    }
})();
</script>
<!-- excalidraw end -->
{{- end }}
{{- if $hasDrawio }}<!-- draw.io begin -->
  {{- $drawioViewerJs := "https://viewer.diagrams.net/js/viewer-static.min.js" -}}
  {{- with $.Site.Params.drawio -}}
    {{- with .js -}}
      {{- $drawioViewerJs = . -}}
    {{- end -}}
  {{- end -}}
<script type="text/javascript">
// Process drawio code blocks and shortcode inline elements
window.drawioViewerLoaded = false;
window.drawioCodeBlocksProcessed = false;

window.processDrawioCodeBlocks = function() {
    if (window.drawioCodeBlocksProcessed) return;
    window.drawioCodeBlocksProcessed = true;
    
    const isDrawioCodeBlock = (el) => {
        if (!el || !el.className) return false;
        return /(^|\s)language-(\{)?drawio(\})?(\s|$)/i.test(el.className) || 
               /\bdrawio-root\b/i.test(el.className);
    };

    // Process code blocks
    for (const codeEl of document.querySelectorAll('pre>code')) {
        if (!isDrawioCodeBlock(codeEl)) continue;
        const preEl = codeEl.parentElement;
        if (!preEl) continue;
        
        const xmlContent = codeEl.textContent || '';
        if (!xmlContent.trim()) continue;
        
        // Create container
        const container = document.createElement('div');
        container.className = 'drawio-container';
        container.style.cssText = 'width: 100%; margin: 1rem 0;';
        
        // Create mxgraph div with data URL
        const mxDiv = document.createElement('div');
        mxDiv.className = 'mxgraph';
        mxDiv.style.cssText = 'max-width: 100%; border: 1px solid transparent;';
        
        // Create data URL with base64 encoded XML
        const base64Xml = btoa(unescape(encodeURIComponent(xmlContent.trim())));
        const dataUrl = 'data:text/xml;base64,' + base64Xml;
        mxDiv.setAttribute('data-mxgraph', JSON.stringify({
            highlight: '#0000ff',
            nav: true,
            resize: true,
            toolbar: 'zoom layers lightbox',
            edit: '_blank',
            url: dataUrl
        }));
        
        container.appendChild(mxDiv);
        
        // Replace pre with container
        preEl.parentNode.insertBefore(container, preEl);
        preEl.style.display = 'none';
    }
    
    // Process pending shortcode inline elements (with data-drawio-config-id)
    for (const el of document.querySelectorAll('.drawio-pending[data-drawio-config-id]')) {
        const configId = el.getAttribute('data-drawio-config-id');
        if (!configId) continue;
        const configEl = document.getElementById(configId);
        if (!configEl) continue;
        
        try {
            // Get the raw XML content from the script tag
            const xmlContent = configEl.textContent || '';
            if (!xmlContent.trim()) continue;
            
            const page = el.getAttribute('data-drawio-page') || '0';
            
            // Create data URL with base64 encoded XML
            const base64Xml = btoa(unescape(encodeURIComponent(xmlContent.trim())));
            const dataUrl = 'data:text/xml;base64,' + base64Xml;
            
            // Set the data-mxgraph attribute
            el.setAttribute('data-mxgraph', JSON.stringify({
                highlight: '#0000ff',
                nav: true,
                resize: true,
                toolbar: 'zoom layers lightbox',
                edit: '_blank',
                page: parseInt(page),
                url: dataUrl
            }));
            el.classList.remove('drawio-pending');
            el.classList.add('mxgraph');
        } catch (e) {
            if (window.console) {
                console.error('Failed to process drawio config:', e);
            }
        }
    }
};

window.initDrawioViewer = function() {
    if (typeof GraphViewer !== 'undefined') {
        GraphViewer.processElements();
    }
};

window.onDrawioReady = function() {
    window.drawioViewerLoaded = true;
    // If DOM is already loaded, init viewer now
    if (document.readyState !== 'loading') {
        window.processDrawioCodeBlocks();
        window.initDrawioViewer();
    }
};

// Process on DOMContentLoaded and init viewer if loaded
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
        window.processDrawioCodeBlocks();
        if (window.drawioViewerLoaded) {
            window.initDrawioViewer();
        }
    });
} else {
    window.processDrawioCodeBlocks();
    if (window.drawioViewerLoaded) {
        window.initDrawioViewer();
    }
}
</script>
<script type="text/javascript" src="{{ $drawioViewerJs | safeURL }}" onload="window.onDrawioReady();"></script>
<!-- draw.io end -->
{{- end }}
{{ with $.Site.Params.styleimport }}<!-- style import begin -->
<script type="text/javascript">
document.addEventListener('DOMContentLoaded', (event) => {
    setTimeout(function() {
        var import_items = '';
        {{- range $url := .urls }}
        import_items += "@import url('{{ $url | safeJS }}');\r\n";
        {{ end }}

        if (import_items) {
            const import_style = document.createElement('style');
            import_style.innerHTML = import_items;
            document.querySelector('head').appendChild(import_style);
        }
    }, {{ default 256 .delay }});
});
</script>
<!-- style import end -->
{{- end }}
{{- with $.Site.Params.Content }}
  {{- with .after_footer }}
    {{- range . -}}
    <script
      {{- with .attributes }}
        {{- range $k, $v := . -}}
            {{- " " | safeHTMLAttr }}{{ $k | safeHTMLAttr }}="{{ $v | safeHTMLAttr }}"
        {{- end -}}
      {{- end -}}
    >
      {{- with .content }}
        {{- . | safeJS }}
      {{- end -}}
    </script>
    {{- end}}
  {{- end}}
{{- end}}
