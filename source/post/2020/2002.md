---
author: owent
categories:
  - Article
  - Blablabla
date: 2020-02-07 21:43:50
draft: true
id: 2002
tags: 
  - nftables
  - nft
  - iptables
  - ebtables
  - ipset
  - nat
title: nftables初体验
type: post
---

前言
----------------------------------------------

之前一直耳闻 [nftables][2] 是下一代 [iptables][3] 。前段时间配了一台主机，折腾成家里的软路由。就一并来尝鲜一系列新东西，其中就包括 [nftables][2] 。[nftables][2] 和 [iptables][3] 、[ebtables][7] 等一样，都是对底层 xtables 的封装，目前看来 [nftables][2] 比 [iptables][3] 更简洁易用，更易读，更容易理解，扩展性和也更好。但是目前各个发行版中对 [nftables][2] 的支持还比较参差不齐，导致 [nftables][2] 很多功能比 [iptables][3] 还是有所缺失，所以个人感觉短期内还是替代不了 [iptables][3] （比如 tproxy 功能需要 linux kernel 4.19+， 而即便是 [CentOS 8][6] 的内核版本也只是 4.18 ，所以都不支持 ）。 [nftables][2] 所支持的功能列表及所以来的内核版本和内核模块可以在这里找到 https://wiki.nftables.org/wiki-nftables/index.php/Supported_features_compared_to_xtables 。

[nftables][2] 的功能分两块，一块是内核支持，这个受限于内核版本。另一部分是用户空间的库和工具。有些发行版会滚动更新内核，但是 [nftables][2] 版本比较低，这时候如果要用就得自己编译。[nftables][2] 依赖库及命令行工具的代码仓库如下:

+ libmnl: http://git.netfilter.org/libmnl/
+ libnftnl: http://git.netfilter.org/libnftnl/
+ nftables: http://git.netfilter.org/nftables/

和 [podman][4] 一样， [nftables][2] 的高版本对依赖库的版本也有一定要求，系统自带的不一定符合要求，就得一个一个编译。我写了一个构建脚本: https://github.com/owent-utils/docker-setup/blob/master/build-nftables.sh ， 并且实测如果使用 [podman][4] 或者 [docker][5] 的话，可以宿主机编译，然后mount共享给子机也是可以的。

官方Wiki: https://wiki.nftables.org
官方文档: https://www.netfilter.org/projects/nftables/manpage.html
官方文档不是很全，这个文档更完整一些: https://www.mankier.com/8/nft

nftables与iptables
----------------------------------------------

nftables与ebtables
----------------------------------------------

按住奥文档的说法 （ https://www.mankier.com/8/ebtables-legacy#Description-Tables ）， 在 BROUTE 链DROP掉包，能阻止桥接来的包走转发规则，从而转走路由规则。 但是在 [nftables][2] 的文档里仅有 https://www.mankier.com/8/nft#Statements-Payload_Statement 里写了个例子改路由

https://www.mankier.com/8/ebtables-nft 目前还不支持对 BROUTE 的HOOK。

nftables与ipset
----------------------------------------------

[ipset][8] 的 skbinfo插件 和 [nftables][2] 的map

nftables与iptables与NAT
----------------------------------------------

nftables与firewalld
----------------------------------------------

备注小记
----------------------------------------------


[1]: https://github.com/owent-utils/docker-setup
[2]: https://nftables.org/projects/nftables/index.html
[3]: https://nftables.org/projects/iptables/index.html
[4]: https://podman.io/
[5]: https://www.docker.com/
[6]: https://www.centos.org/
[7]: http://ebtables.netfilter.org/
[8]: https://nftables.org/projects/ipset/index.html
